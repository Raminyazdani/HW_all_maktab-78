<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>transaction panel</title>
    <meta content="" name="keywords">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/callender/fonts/icomoon/style.css">
    <link rel="stylesheet" href="../static/callender/css/classic.css">
    <link rel="stylesheet" href="../static/callender/css/classic.date.css">
    <link rel="stylesheet" href="../static/callender/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/callender/css/style.css">
    <script src="../static/callender/js/jquery-3.3.1.min.js"></script>
    <script src="../static/callender/js/popper.min.js"></script>
    <script src="../static/callender/js/bootstrap.min.js"></script>
    <script src="../static/callender/js/picker.js"></script>
    <script src="../static/callender/js/picker.date.js"></script>
    <script src="../static/callender/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js"
            integrity="sha512-FJ2OYvUIXUqCcPf1stu+oTBlhn54W0UisZB/TNrZaVMHHhYvLBV9jMbvJYtvDe5x/WVaoXZ6KB+Uqe5hT2vlyA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link
            rel=
                    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
            type="text/css"
    />
    <script src=
                    "https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script
            src=
                    "https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"
            type="text/javascript"
    ></script>
    <script src=
                    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src=
                    "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.2/Chart.min.js"></script>


    <script>


    </script>
    <script>

        async function init_merchants() {
            const merchants = await get_merchants();
            const merchant_list = [];
            for (let i = 0; i < merchants.length; i++) {
                merchant_list.push(merchants[i]["merch_id"])
            }
            return merchant_list;
        }

        async function get_merchants() {
            const url = 'http://127.0.0.1:5000/merchants/'
            try {
                let res = await fetch(url);
                return res.json();
            } catch (error) {
                console.log(error);
            }
        }

        var merchant_list = init_merchants()


    </script>
</head>

<body>


<main id="main2" class="">

    <div class="page_title">
        <h1>transaction panel</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">transaction panel/chart</a></li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <section class="container_fluid">
        <!-- Start Card -->
        <div class="card">
            <!-- Start Card Body -->
            <div class="card-body">
                <!-- Start Form -->
                <form id="query_transaction" method="post" class="needs-validation p-2" novalidate
                      autocomplete="off">
                    <div class="form-group d-flex  justify-content-between  p-1 m-1">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="input_from">From</label>
                                <input class="col-12" type="date" name="input_from" id="input_from">
                                <div class="d-flex flex-row justify-content-between py-2">
                                    <div class="form-group col-3 p-0">
                                        <label for="hour_start">hour</label>
                                        <input type="number" class="form-control" id="hour_start" name="hour_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=23
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill hour</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="minute_start">minute</label>
                                        <input type="number" class="form-control" id="minute_start" name="minute_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=59
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill minute</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="seconds_start">seconds</label>
                                        <input type="number" class="form-control" id="seconds_start"
                                               name="seconds_start"
                                               placeholder=0
                                               min=0
                                               max=59
                                               value=0

                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill seconds</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="milliseconds_start">milliseconds</label>
                                        <input type="number" class="form-control" id="milliseconds_start"
                                               name="milliseconds_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=999
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill milliseconds</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="input_to">To</label>
                                <input class="col-12" type="date" name="input_to" id="input_to">

                                <div class="d-flex flex-row justify-content-between  py-2">
                                    <div class="form-group col-3 p-0">
                                        <label for="hour_end">hour</label>
                                        <input type="number" class="form-control" id="hour_end" name="hour_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=23
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill hour</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="minute_end">minute</label>
                                        <input type="number" class="form-control" id="minute_end" name="minute_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=59
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill minute</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="seconds_end">seconds</label>
                                        <input type="number" class="form-control" id="seconds_end" name="seconds_end"
                                               placeholder=0
                                               min=0
                                               max=59
                                               value=0

                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill seconds</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="milliseconds_end">milliseconds</label>
                                        <input type="number" class="form-control" id="milliseconds_end"
                                               name="milliseconds_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=999
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill milliseconds</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="form-group d-flex flex-row justify-content-between  p-1 m-1">

                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>sort</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="sort" name="sort"
                                        required>
                                    <option value=1 selected>ascending</option>
                                    <option value=-1>descending</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>currency</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="currency" name="currency"
                                        required>
                                    <option value="rial" selected>rial</option>
                                    <option value="toman">toman</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>time_type</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="time_type" name="time_type"
                                        required>
                                    <option value="none" selected>none</option>
                                    <option value="year">year</option>
                                    <option value="month">month</option>
                                    <option value="week">week</option>
                                    <option value="day">day</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>user</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <input type="text" class="form-control" id="user" name="user"
                                       placeholder="merchant_id:6 OR 5"
                                       value=""
                                       autocomplete="off"
                                />
                            </div>

                        </div>
                    </div>
                    <!-- End Input Start Time -->
                    <div class="form-group d-flex flex-row justify-content-between  p-1 m-1">

                        <div class="form-group col-12 col-md-12 p-1 m-1 justify-content-center">
                            <label>form controls</label>
                            <!-- Start Submit Button -->
                            <div class="d-block d-md-flex col-12 col-md-12">
                                <button class="btn btn-primary btn-block col-12 col-md-2 m-1" onclick="ajax_fecth()">
                                    Submit
                                </button>
                                <!-- End Submit Button -->
                                <!-- Start reset Button -->
                                <button class="btn btn-primary btn-block col-12 col-md-2 m-1" type="reset">Reset
                                </button>

                                <!-- End reset Button -->
                            </div>
                        </div>
                    </div>


                </form>
                <!-- End Form -->
            </div>

            <!-- End Card Body -->
        </div>
        <!-- End Card -->

        <div class="container_fluid">
            <center><h2>chart is zoomable</h2></center>

            <div id="loading" class="justify-content-center" style="display: flex;background-color: white">
                <center>
                    <img src="../static/Loading_icon.gif"></center>
            </div>

            <div id="chartContainer" style="height: 370px; width: 100%;"></div>
        </div>
    </section>

</main>

<script>
    async function autocomplete(inp) {
        arr = await init_merchants()
        /*the autocomplete function takes two arguments,
        the text field element and an array of possible autocompleted values:*/
        var currentFocus;
        /*execute a function when someone writes in the text field:*/
        inp.addEventListener("select", function (e) {

        }

        inp.addEventListener("input", function (e) {
            var a, b, i, val = this.value;
            /*close any already open lists of autocompleted values*/
            closeAllLists();
            if (!val) {
                show_recommend(a, b, i, val)
            }
            currentFocus = -1;
            /*create a DIV element that will contain the items (values):*/
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            /*append the DIV element as a child of the autocomplete container:*/
            this.parentNode.appendChild(a);
            /*for each item in the array...*/
            for (i = 0; i < arr.length; i++) {
                /*check if the item starts with the same letters as the text field value:*/
                if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                    /*create a DIV element for each matching element:*/
                    b = document.createElement("DIV");
                    /*make the matching letters bold:*/
                    b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                    b.innerHTML += arr[i].substr(val.length);
                    /*insert a input field that will hold the current array item's value:*/
                    b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                    /*execute a function when someone clicks on the item value (DIV element):*/
                    b.addEventListener("click", function (e) {
                        /*insert the value for the autocomplete text field:*/
                        inp.value = this.getElementsByTagName("input")[0].value;
                        /*close the list of autocompleted values,
                        (or any other open lists of autocompleted values:*/
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            }
        });
        /*execute a function presses a key on the keyboard:*/
        inp.addEventListener("keydown", function (e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                /*If the arrow DOWN key is pressed,
                increase the currentFocus variable:*/
                currentFocus++;
                /*and and make the current item more visible:*/
                addActive(x);
            } else if (e.keyCode == 38) { //up
                /*If the arrow UP key is pressed,
                decrease the currentFocus variable:*/
                currentFocus--;
                /*and and make the current item more visible:*/
                addActive(x);
            } else if (e.keyCode == 13) {
                /*If the ENTER key is pressed, prevent the form from being submitted,*/
                e.preventDefault();
                if (currentFocus > -1) {
                    /*and simulate a click on the "active" item:*/
                    if (x) x[currentFocus].click();
                }
            }
        });

        function addActive(x) {
            /*a function to classify an item as "active":*/
            if (!x) return false;
            /*start by removing the "active" class on all items:*/
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            /*add class "autocomplete-active":*/
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            /*a function to remove the "active" class from all autocomplete items:*/
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            /*close all autocomplete lists in the document,
            except the one passed as an argument:*/
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        function show_recommend(a, b, i, val) {
            var a, b, i, val = this.value;

            currentFocus = -1;
            /*create a DIV element that will contain the items (values):*/
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            /*append the DIV element as a child of the autocomplete container:*/
            this.parentNode.appendChild(a);
            /*for each item in the array...*/
            for (i = 0; i < arr.length; i++) {
                /*check if the item starts with the same letters as the text field value:*/
                /*create a DIV element for each matching element:*/
                b = document.createElement("DIV");
                /*make the matching letters bold:*/
                b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                b.innerHTML += arr[i].substr(val.length);
                /*insert a input field that will hold the current array item's value:*/
                b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                /*execute a function when someone clicks on the item value (DIV element):*/
                b.addEventListener("click", function (e) {
                    /*insert the value for the autocomplete text field:*/
                    inp.value = this.getElementsByTagName("input")[0].value;
                    /*close the list of autocompleted values,
                    (or any other open lists of autocompleted values:*/
                    closeAllLists();
                });
                a.appendChild(b);
            }


        }

        /*execute a function when someone clicks in the document:*/
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    /*An array containing all the country names in the world:*/

    /*initiate the autocomplete function on the "myInput" element, and pass along the countries array as possible autocomplete values:*/
    autocomplete(document.getElementById("user"));
</script>


</script>

<script>
    async function get_data(form_data) {

        if (form_data) {
            form_data = JSON.stringify(form_data)
            const res = await request_ajax_data(form_data)

            function request_ajax_data(form_data) {

                return $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:5000/transaction/',
                    data: form_data,
                    dataType: "json",
                    contentType: "application/json",
                    error: function (request, status, error) {
                        console.log('Error: ' + error);
                    },
                    success: function (response) {
                        console.log(response)

                    }
                })
            }

            return res

        } else {
            get_data({})
            const url = 'http://127.0.0.1:5000/transaction/'
            try {
                let res = await fetch(url);
                return res.json();
            } catch (error) {
                console.log(error);
            }
        }
    }

    async function get_data_object(form_data) {
        var data_values = await get_data(form_data);
        return data_values;
    }

    async function initial_chart(form_data = null) {
        document.getElementById("loading").style.display = "block"
        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "light1", // "light1", "light2", "dark1", "dark2"
            animationEnabled: true,
            zoomEnabled: true,
            title: {
                text: "transaction"
            }, axisX: {
                labelAngle: -90,
            },

            data: [{
                type: "area",
                dataPoints: []
            }]
        });

        addDataPoints(await get_data_object(form_data));
        chart.render();
        document.getElementById("loading").style.display = "none"


        function getMax(arr, prop) {
            var max;
            for (var i = 0; i < arr.length; i++) {
                if (max == null || parseInt(arr[i][prop]) > parseInt(max[prop]))
                    max = arr[i];
            }
            return max;
        }

        function addDataPoints(key_values) {

            var maxvalue = getMax(key_values, "value");
            var xVal = chart.options.data[0].dataPoints.length + 1, yVal = maxvalue;

            for (var i = 0; i < key_values.length; i++) {
                yVal = key_values[i]["value"];
                xVal = key_values[i]["key"];
                chart.options.data[0].dataPoints.push({label: xVal, y: yVal});
            }
        }


    }

    $("form").submit(function (e) {
        e.preventDefault();
    });
    window.onload = initial_chart()

    function ajax_fecth() {
        var form_data = $("form").serializeArray();
        var new_data_array_form = {};
        for (let i = 0; i < form_data.length; i++) {
            temp = form_data[i];
            key = temp["name"]
            value = temp["value"]
            if (key == "input_to") {
                if (value == "") {
                    value = "2023-01-01"
                }
            }
            if (key == "input_from") {
                if (value == "") {
                    value = "0001-01-01"
                }
            }
            new_data_array_form[key] = value;
        }
        form_data = new_data_array_form
        sending_data = {
            user: form_data["user"],
            sort: form_data["sort"],
            currency: form_data["currency"],
            time_type: form_data["time_type"],
            start_time: form_data["input_from"] + ("-") + form_data["hour_start"] + ("-") + form_data["minute_start"] + ("-") + form_data["seconds_start"] + ("-") + form_data["milliseconds_start"],
            end_time: form_data["input_to"] + ("-") + form_data["hour_end"] + ("-") + form_data["minute_end"] + ("-") + form_data["seconds_end"] + ("-") + form_data["milliseconds_end"],
        }
        initial_chart(sending_data)
    }


</script>
<script>
    function results() {
        var x = $("#query_transaction").serializeArray();
        console.log(x);
    }

</script>
</body>
</html>