<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>transaction panel</title>
    <meta content="" name="keywords">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="fonts/icomoon/style.css">
    <link rel="stylesheet" href="../static/callender/css/classic.css">
    <link rel="stylesheet" href="../static/callender/css/classic.date.css">
    <link rel="stylesheet" href="../static/callender/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/callender/css/style.css">
    <script src="../static/callender/js/jquery-3.3.1.min.js"></script>
    <script src="../static/callender/js/popper.min.js"></script>
    <script src="../static/callender/js/bootstrap.min.js"></script>
    <script src="../static/callender/js/picker.js"></script>
    <script src="../static/callender/js/picker.date.js"></script>
    <script src="../static/callender/js/main.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <link
            rel=
                    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
            type="text/css"
    />
    <script src=
                    "https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script
            src=
                    "https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"
            type="text/javascript"
    ></script>
    <script src=
                    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src=
                    "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.2/Chart.min.js"></script>


    <script>


    </script>

</head>

<body>


<main id="main2" class="">

    <div class="page_title">
        <h1>transaction panel</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">transaction panel/chart</a></li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <section class="container_fluid">
        <!-- Start Card -->
        <div class="card">
            <!-- Start Card Body -->
            <div class="card-body">
                <!-- Start Form -->
                <form id="query_transaction" method="post" class="needs-validation p-2" novalidate
                      autocomplete="off">
                    <div class="form-group d-flex  justify-content-between  p-1 m-1">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="input_from">From</label>
                                <input class="col-12" type="date" name="input_from" id="input_from">
                                <div class="d-flex flex-row justify-content-between py-2">
                                    <div class="form-group col-3 p-0">
                                        <label for="hour_start">hour</label>
                                        <input type="number" class="form-control" id="hour_start" name="hour_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=23
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill hour</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="minute_start">minute</label>
                                        <input type="number" class="form-control" id="minute_start" name="minute_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=59
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill minute</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="seconds_start">seconds</label>
                                        <input type="number" class="form-control" id="seconds_start"
                                               name="seconds_start"
                                               placeholder=0
                                               min=0
                                               max=59
                                               value=0

                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill seconds</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="milliseconds_start">milliseconds</label>
                                        <input type="number" class="form-control" id="milliseconds_start"
                                               name="milliseconds_start"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=999
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill milliseconds</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="input_to">To</label>
                                <input class="col-12" type="date" name="input_to" id="input_to">

                                <div class="d-flex flex-row justify-content-between  py-2">
                                    <div class="form-group col-3 p-0">
                                        <label for="hour_end">hour</label>
                                        <input type="number" class="form-control" id="hour_end" name="hour_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=23
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill hour</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="minute_end">minute</label>
                                        <input type="number" class="form-control" id="minute_end" name="minute_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=59
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill minute</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="seconds_end">seconds</label>
                                        <input type="number" class="form-control" id="seconds_end" name="seconds_end"
                                               placeholder=0
                                               min=0
                                               max=59
                                               value=0

                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill seconds</small>
                                    </div>
                                    <div class="form-group col-3 p-0">
                                        <label for="milliseconds_end">milliseconds</label>
                                        <input type="number" class="form-control" id="milliseconds_end"
                                               name="milliseconds_end"
                                               placeholder=0
                                               min=0
                                               value=0
                                               max=999
                                               oninput="validity.valid||(value=0);"
                                        />
                                        <small class="form-text text-muted">Please fill milliseconds</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="form-group d-flex flex-row justify-content-between  p-1 m-1">

                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>sort</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="sort" name="sort"
                                        required>
                                    <option value=1 selected>ascending</option>
                                    <option value=-1>descending</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>currency</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="currency" name="currency"
                                        required>
                                    <option value="rial" selected>rial</option>
                                    <option value="toman">toman</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>time_type</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <select class="form-control mr-1" id="time_type" name="time_type"
                                        required>
                                    <option value="none" selected>none</option>
                                    <option value="year">year</option>
                                    <option value="month">month</option>
                                    <option value="week">week</option>
                                    <option value="day">day</option>
                                </select>
                            </div>

                        </div>
                        <div class="form-group col-3">
                            <!-- Start Input Date -->
                            <label>user</label>

                            <div class="d-flex flex-row justify-content-between align-items-center">
                                <input type="text" class="form-control" id="user" name="user"
                                       placeholder="merchant_id"
                                       value=""
                                />
                            </div>

                        </div>
                    </div>
                    <!-- End Input Start Time -->
                    <div class="form-group d-flex flex-row justify-content-between  p-1 m-1">

                        <div class="form-group col-12 col-md-12 p-1 m-1 justify-content-center">
                            <label>form controls</label>
                            <!-- Start Submit Button -->
                            <div class="d-block d-md-flex col-12 col-md-12">
                                <button class="btn btn-primary btn-block col-12 col-md-2 m-1" onclick="ajax_fecth()">
                                    Submit
                                </button>
                                <!-- End Submit Button -->
                                <!-- Start reset Button -->
                                <button class="btn btn-primary btn-block col-12 col-md-2 m-1" type="reset">Reset
                                </button>

                                <!-- End reset Button -->
                            </div>
                        </div>
                    </div>


                </form>
                <!-- End Form -->
            </div>

            <!-- End Card Body -->
        </div>
        <!-- End Card -->

        <div class="container_fluid">
            <h2>zoomable Chart</h2>
            <div id="loading" class="justify-content-center" style="display: flex;background-color: white">
                <center>
                    <img src="../static/Loading_icon.gif"></center>
            </div>

            <div id="chartContainer" style="height: 370px; width: 100%;"></div>
        </div>
    </section>

</main>

<script>


</script>

<script>
    async function get_data(form_data) {

        if (form_data) {
            form_data = JSON.stringify(form_data)
            const res = await request_ajax_data(form_data)

            function request_ajax_data(form_data) {

                return $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:5000/transaction/',
                    data: form_data,
                    dataType:"json",
                    contentType:"application/json",
                    error: function (request, status, error) {
                        console.log('Error: ' + error);
                    },
                    success: function (response) {
                        console.log(response)

                    }
                })
            }

            return res

        } else {
            const url = 'http://127.0.0.1:5000/transaction/'
            try {
                let res = await fetch(url);
                return res.json();
            } catch (error) {
                console.log(error);
            }
        }
    }

    async function get_data_object(form_data) {
        var data_values = await get_data(form_data);
        return data_values;
    }

    async function initial_chart(form_data = null) {
        document.getElementById("loading").style.display = "block"
        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "light1", // "light1", "light2", "dark1", "dark2"
            animationEnabled: true,
            zoomEnabled: true,
            title: {
                text: "transaction"
            }, axisX: {
                labelAngle: -90,
            },

            data: [{
                type: "area",
                dataPoints: []
            }]
        });

        addDataPoints(await get_data_object(form_data));
        chart.render();
        document.getElementById("loading").style.display = "none"


        function getMax(arr, prop) {
            var max;
            for (var i = 0; i < arr.length; i++) {
                if (max == null || parseInt(arr[i][prop]) > parseInt(max[prop]))
                    max = arr[i];
            }
            return max;
        }

        function addDataPoints(key_values) {

            var maxvalue = getMax(key_values, "value");
            var xVal = chart.options.data[0].dataPoints.length + 1, yVal = maxvalue;

            for (var i = 0; i < key_values.length; i++) {
                yVal = key_values[i]["value"];
                xVal = key_values[i]["key"];
                chart.options.data[0].dataPoints.push({label: xVal, y: yVal});
            }
        }


    }

    $("form").submit(function (e) {
        e.preventDefault();
    });
    window.onload = initial_chart()

    function ajax_fecth() {
        var form_data = $("form").serializeArray();
        var new_data_array_form = {};
        for (let i = 0; i < form_data.length; i++) {
            temp = form_data[i];
            key = temp["name"]
            value = temp["value"]
            if (key == "input_to") {
                if (value == "") {
                    value = "2023-01-01"
                }
            }
            if (key == "input_from") {
                if (value == "") {
                    value = "0001-01-01"
                }
            }
            new_data_array_form[key] = value;
        }
        form_data = new_data_array_form
        sending_data = {
            user: form_data["user"],
            sort: form_data["sort"],
            currency: form_data["currency"],
            time_type: form_data["time_type"],
            start_time: form_data["input_from"] + ("-") + form_data["hour_start"] + ("-") + form_data["minute_start"] + ("-") + form_data["seconds_start"] + ("-") + form_data["milliseconds_start"],
            end_time: form_data["input_to"] + ("-") + form_data["hour_end"] + ("-") + form_data["minute_end"] + ("-") + form_data["seconds_end"] + ("-") + form_data["milliseconds_end"],
        }
        initial_chart(sending_data)
    }


</script>
<script>
    function results() {
        var x = $("#query_transaction").serializeArray();
        console.log(x);
    }

</script>
</body>
</html>